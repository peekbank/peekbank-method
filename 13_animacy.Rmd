---
title: '13: Animacy effects'
author: "Peekbank team"
date: "2025-08-25"
output: html_document
---

```{r setup, echo = FALSE, message = FALSE}
library(here)
library(tidyverse)
library(peekbankr)
library(lme4)
library(ggpmisc)
library(ggrepel)
library(ggthemes)
library(cowplot)

# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed, cache = TRUE, 
                      message=FALSE, warning=FALSE, error=FALSE)

figure_path <- here("figures")

load(file = here("cached_intermediates","1_d_trial.Rds"))
d_rt <- readRDS(file = here("cached_intermediates","4_d_rt.Rds"))
```

# Process d_trial data

```{r}
d_trial <- d_aoi |>
  mutate(short_window = t_norm > 200 & t_norm <= 2000,
         long_window = t_norm > 500 & t_norm <= 4000) |>
  group_by(dataset_name, dataset_id, administration_id,
           trial_id, age, target_label, distractor_label) |>
  summarise(short_window_accuracy = mean(correct[short_window], na.rm=TRUE),
            long_window_accuracy = mean(correct[long_window], na.rm=TRUE),
            short_window_prop_data = sum(!is.na(correct[short_window]), na.rm = TRUE) /
              length(correct[short_window]),
            long_window_prop_data = sum(!is.na(correct[long_window]), na.rm = TRUE) / 
              length(correct[long_window]),
            short_window_target = sum(correct[short_window], na.rm=TRUE),
            long_window_target = sum(correct[long_window], na.rm=TRUE),
            target_baseline = sum(correct[t_norm <= 200], na.rm=TRUE),
            short_window_distractor = sum(!correct[short_window], na.rm=TRUE),
            long_window_distractor = sum(!correct[long_window], na.rm=TRUE)) |>
  mutate(short_window_elogit = log((short_window_target + .5) / (short_window_distractor + .5)),
         long_window_elogit = log((long_window_target + .5) / (long_window_distractor + .5)),
         baseline_elogit = log((target_baseline + .5) / ( (target_baseline + .5) ))) |> 
  mutate(
    log_age = log(age)
  ) |> 
  ungroup() |>
  mutate(
    log_age_centered = log_age - mean(log_age)
  )

```

# Load in animate and inanimate data

```{r}
animacy_labels <- read_csv(here("metadata","animates.csv"))

d_trial <- d_trial |>
  left_join(animacy_labels, by = c("target_label" = "item")) |>
  rename(animate_target = animate) |>
  left_join(animacy_labels, by = c("distractor_label" = "item")) |>
  rename(animate_distractor = animate) |> 
  mutate(
    animate_target = ifelse(is.na(animate_target), FALSE, animate_target),
    animate_distractor = ifelse(is.na(animate_distractor), FALSE, animate_distractor)
  )
```

# Fit models

RT model: 

```{r}
# mod_rt <- lmer(log_rt ~ log_age_centered +
#               (1 | administration_id) +
#               (1 | dataset_name) +
#               (log_age_centered | target_label),
#             data = d_rt_dt)
```

Accuracy model:

```{r}
lmm_fit <- lmer(long_window_elogit ~ log_age_centered * animate_target + 
                  log_age_centered * animate_distractor +
                  (1 | administration_id) + 
                  (log_age_centered | dataset_name) + 
                  (log_age_centered | target_label) + 
                  (1 | distractor_label), 
                data = d_trial, 
                control = lmerControl(optimizer="bobyqa"))

d_trial <- d_trial %>%
  mutate(
    animate_target_c = ifelse(animate_target,0.5,-0.5),
    animate_distractor_c=ifelse(animate_distractor,0.5,-0.5)
  )

lmm_fit_c <- lmer(long_window_elogit ~ log_age_centered * animate_target_c + 
                  log_age_centered * animate_distractor_c +
                  (1 | administration_id) + 
                  (log_age_centered | dataset_name) + 
                  (log_age_centered | target_label) + 
                  (1 | distractor_label), 
                data = d_trial, 
                control = lmerControl(optimizer="bobyqa"))
summary(lmm_fit_c)

```


ANIMACY PLOT INFO

```{r}
preds <- expand_grid(
  animate_target = c(TRUE, FALSE), 
  animate_distractor = c(TRUE, FALSE), 
  log_age_centered = seq(min(d_trial$log_age_centered),
                max(d_trial$log_age_centered), .1))
preds <- preds |>
  mutate(.pred = predict(lmm_fit, 
                         type = "response",
                         re.form = NA, 
                         newdata = preds), 
         age = exp(log_age_centered + mean(d_trial$log_age)))
# animate_plot <- 
  ggplot(d_trial,
       aes(x = age, y = long_window_elogit)) + 
  geom_point(alpha = .1) + 
  geom_line(data = preds, 
            aes(y = .pred, col = animate_target, lty = animate_distractor), 
            size = 1.5) + 
  geom_hline(lty = 2, yintercept = 0) + 
  scale_x_continuous(breaks = c(12,24,36,48,60)) + 
  scale_color_solarized(name = "Animate target") + 
  scale_linetype(name = "Animate distractor") + 
  ylab("Trial-level accuracy (elogit)") + 
  xlab("Age (months)") + 
  ggthemes::theme_few()


```

Plots for presenting

```{r}
ggplot(d_trial,
       aes(x = age, y = long_window_elogit)) + 
  geom_point(alpha = .01, height = 0,position = position_jitter(seed = 42,width=0.2))+
  geom_line(data = preds, 
            aes(y = .pred, col = animate_target, lty = animate_distractor), 
            size = 1.5) + 
  geom_hline(lty = 2, yintercept = 0) + 
  scale_x_continuous(breaks = c(12,24,36,48,60)) + 
  scale_color_solarized(name = "Target",breaks=c(FALSE,TRUE),labels=c("Inanimate","Animate")) + 
  scale_linetype(name = "Distractor",breaks=c(FALSE,TRUE),labels=c("Inanimate","Animate")) + 
  ylab("Trial-level accuracy (elogit)") + 
  xlab("Age (months)") + 
  theme_cowplot(font_size=20)
ggsave(here(figure_path,"animacy_effects.png"),width=10,height=6,dpi=600)

ggplot(d_trial,
       aes(x = age, y = long_window_elogit)) + 
  geom_point(alpha = .01, height = 0,position = position_jitter(seed = 42,width=0.2),color=NA,fill=NA)+
  geom_line(data = preds, 
            aes(y = .pred, col = animate_target, lty = animate_distractor), 
            size = 1.5,
            color=NA,
            fill=NA) + 
  geom_hline(lty = 2, yintercept = 0) + 
  scale_x_continuous(breaks = c(12,24,36,48,60)) + 
  scale_color_solarized(name = "Target",breaks=c(FALSE,TRUE),labels=c("Inanimate","Animate")) + 
  scale_linetype(name = "Distractor",breaks=c(FALSE,TRUE),labels=c("Inanimate","Animate")) + 
  ylab("Trial-level accuracy (elogit)") + 
  xlab("Age (months)") + 
  theme_cowplot(font_size=20)
ggsave(here(figure_path,"animacy_effects_setup.png"),width=10,height=6,dpi=600)
```

